---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Understanding SPC Charts {#charts-intro}


```{r, echo=FALSE}
knitr::opts_chunk$set(fig.asp = 3/5,
                      echo = FALSE,
                      dev     = 'svg')
library(kableExtra)
library(qicharts2)

options(qic.clshade = F)

source('R/stdchart.R', local = knitr::knit_global())
source('R/load_data.R', local = knitr::knit_global())
```

Now that we’ve explored the concepts of common and special cause variation through the example of handwritten letters, the next step is understanding how to apply these ideas to healthcare processes. This application involves creating charts that represent the "voice" or behavior of a process (usually) over time. By leveraging statistical theory, these charts help determine whether a process is exhibiting common or special cause variation. Such visualisations are known as SPC charts, control charts, or process behavior charts.

SPC charts are point-and-line plots of data collected over time. They serve as operational definitions for identifying common and special cause variation. An operational definition is one that is designed to be practical, useful, and ensures consistency in interpretation across different individuals.

```{r spc-fig0, fig.cap='Control chart of systolic blood pressure'}
qic(systolic, 
    chart = 'i',
    title = 'Systolic blood pressure',
    ylab = 'mmHg',
    xlab = 'Day #')
```

Figure \@ref(fig:spc-fig0) illustrates a control chart showing daily blood pressure measurements. One data point (#6), marked with a red dot, stands out from the others. This deviation triggers a signal, indicating that the data point is likely due to a special cause.

Special causes are signalled by unusual patterns in data. By "unusual" we mean something that is unlikely to have happened purely by chance, like a freak data point. Common cause variation is simply noise. The absence of signals of special cause variation is evidence that the behaviour of the process is consistent with common cause variation. The presence of signals is consistent with special cause variation.

There are many different types of control charts and the chart to be used is determined mostly by the type of data to be plotted. But regardless of the type of data, (most) SPC charts look the same and are interpreted the same way, by employing a set of statistical tests (or rules) to help identify unusual patterns.

In this chapter, we introduce the most common types of control charts used in healthcare and their practical applications. In the following chapter (\@ref(testing)), we delve into the rules and statistical tests for identifying unusual patterns in data. Later, in Part 2 of this book, we provide a detailed guide on performing the calculations necessary to construct and analyze control charts.

## Anatomy and physiology of SPC charts

Shewhart’s groundbreaking innovation was the introduction of control limits, which define the boundaries of common cause variation in data. Data points falling within these limits (without unsuual patterns) indicate common cause variation, while those outside indicate special cause variation.

```{r spc-fig1, fig.cap='Standardised control chart. SD = standard deviation; CL = centre line; LCL = lower control limit; UCL = upper control limit', echo=FALSE}
set.seed(33)
y1 <- y2 <- y3 <- rnorm(24)

stdchart(y1)
```

Figure \@ref(fig:spc-fig1) demonstrates a standardized Shewhart control chart, created using random numbers from a normal distribution with a mean of 0 and a standard deviation of 1. The x-axis represents time or sequence order, while the y-axis displays the indicator values. Each dot, connected by a line, represents a data point sampled sequentially. The chart features:

A Center Line (CL), which represents the mean of the data values.
Lower Control Limit (LCL) and Upper Control Limit (UCL), defining the range of common cause variation, often referred to as 3-sigma limits.

The data points cluster symmetrically around the center line, with most near the mean. As the distance from the center line increases, data points become increasingly sparse. The control limits are positioned to encompass nearly all data points arising from common cause variation. Conversely, points outside the limits are likely to represent special causes.

Why 3-Sigma Limits?

Shewhart’s choice of 3-sigma limits was based on empirical observations from real-world experiments. For data following a normal distribution, like in Figure \@ref(fig:spc-fig1), these limits contain about 99.7% of all data points, meaning the likelihood of a point falling outside the limits purely by chance is approximately 3 in 1000 (0.3%). In a control chart with a total of 20 data points the chance of *all* data points being within the control limits is about 95% (1 - 0.997^20^)

But before we go down that rabbit hole we note that these theoretical considerations were rejected by Shewhart who found that most real-life data are not normally distributed. Shewhart argued that the choice of 3-sigma limits was made simply because they "work" (@shewhart1931, p. 18), because this practical choice balances sensitivity (detecting special causes) with specificity (avoiding false alarms), regardless of the data type or distribution. More on this will be discussed in later chapters.

## Some common types of control charts -- The Magnificent Seven


As described above, the control limits are positioned three times the common cause SD above and below the centre line. Thus, all types of control charts follow this general formula for control lines:

$$CL \pm 3SD$$

So to construct a control chart, all we need to know is how to find the process mean and standard deviation. As mentioned before, we do *not* use the overall SD of all the data as this would include any variation due to special causes, which would inflate the control limits. Instead we use a pooled average of the *within* subgroup SDs, which in turn depend on the type of data involved. The impatient reader may find the formulas for constructing control limits in Table \@ref(tab:limits-tab1) later in the book.

Generally, data come in two flavours: count data and measurement data.

### Counts

Counts are positive integers that represent counts of events or cases. The distinction between events and cases is important but somewhat subtle. **Events** are phenomena that happen in time and space, for example patient falls. **Cases** are units with (or without) a certain property, for example patients who fell. 

When counting falls as events, every fall counts. When counting patients who fell as cases, every patient counts -- but only once regardless of how many times each patient fell. 

Both events and cases may be expressed as ratios, that is counts divided by some denominator (area of opportunity). Events may be expressed as **rates**, that is number of events per unit of time, for example number of falls per 1,000 patient days. Cases may be expressed as **proportions**, that is number of cases per total number of cases and non-cases, for example the proportion (or percentage) of patients who fell one or more times.

Notice that with rates the denominator is in units of time, which is a continuous variable and represents something distinctly different from the numerator. With proportions the numerator and denominator are counts of the same thing, for example patients -- only the numerator is a subset of the denominator. Consequently, with proportions the numerators cannot be larger than the denominators.

The most common chart types for count data are:

* **C chart**: count of events, e.g. number of patient falls.
* **U chart**: event rates, e.g. number of patient falls per unit of time.
* **P chart**: case proportions, e.g. proportion of patients who fell.

### Measurements

Measurements are data that are measured on continuous scales and may have decimals, for example blood pressure, height and weight, or waiting times.

As an example, take waiting or "door-to-needle" times. These may be plotted as either **individual** times where each data point (subgroup) represents one patient or as **average** time for all patients in a certain period of time, for example an hour, day, week, or month.

When plotting individual measurement data we use the I chart (aka the X chart). When plotting the average of multiple measurement per subgroup we use the X-bar chart.

Sometimes it is also useful to plot a chart of the within subgroup SDs. For this we use the moving range (MR) chart together with the I chart and the S chart together with the X-bar chart. So for measurement data we have:

* **I and MR charts**: individual measurement, subgroup size = 1.
* **X-bar and S charts**: multiple measurements, subgroup size > 1.

## Common SPC charts in summary

In summary, a Shewhart control chart is a point-and-line plot of data over time with three added horizontal lines: the centre line representing the overall mean of data and the lower and upper control lines representing the limits of the natural process variation.

While there are many types of SPC charts for different types of data they all look and behave the same. In this chapter we introduced the most common types used in healthcare, The Magnificent Seven, and their use cases.

When choosing the right chart we must first decide what type of data we have. For count data there are three common types: C, U, and P charts for event counts, event rates, and proportions respectively. For measurement data we have I and X-bar charts for individual measurements and averages respectively. MR and S charts plot estimates of the within subgroup standard deviation and are often plotted alongside I and X-bar charts.

In the next chapter we will discuss different techniques and rules used to test for signals of special causes, and we will suggest a set of rules that have been thoroughly studied and validated and provide a high sensitivity to special cause variation while keeping the false alarm rate at a reasonable level.
